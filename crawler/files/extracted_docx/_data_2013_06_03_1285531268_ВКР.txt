ПРАВИТЕЛЬСТВО РОССИЙСКОЙ ФЕДЕРАЦИИ



ФЕДЕРАЛЬНОЕ ГОСУДАРСТВЕННОЕ АВТОНОМНОЕ

ОБРАЗОВАТЕЛЬНОЕ УЧРЕЖДЕНИЕ

ВЫСШЕГО ПРОФЕССИОНАЛЬНОГО ОБРАЗОВАНИЯ



«Национальный исследовательский университет

Высшая школа экономики».







Факультет бизнес-информатики

Кафедра бизнес-аналитики







ВЫПУСКНАЯ КВАЛИФИКАЦИОННАЯ РАБОТА





На тему: Оптимизация алгоритмов торговли на финансовом рынке













Студент группы №474

Широков Станислав Олегович







Научный руководитель

профессор, д.т.н., с.н.с.

Кирсанов Александр Петрович







Рецензент

доцент, к.т.н.

Марон Аркадий Исаакович

















Москва 2013




Введение

	Автоматизированные торговые системы интересуют множество людей, торгующих на бирже с появления первых компьютеров. Популярность такого подхода к торговле растет с каждым годом, но до конца еще не изучены все стороны построения эффективной торговой системы даже на сегодняшний день.

	Появляются новые инструменты и методы построения и описания торговых алгоритмов, более мощное программное обеспечение для автоматизированной торговли. Все это создает большой резонанс во взглядах на методы алгоритмической торговли.

	Как бы то ни было, существуют аспекты в данной сфере, без которых невозможно стабильное существование автоматизированной торговой системы. Одним из таких аспектов является оптимизация торговых алгоритмов, а также определения горизонтов их стабильной работы.

	В рамках данного исследования будут рассмотрены современные подходы к оптимизации торговых алгоритмов, а также предложены рекомендации, касательно применения данных подходов и оценки работоспособности системы. Основная цель - получить определенного рода универсальный алгоритм оптимизации торговых систем и оценки горизонтов их устойчивой работы, который будет применим если не к любой, то к большому количеству торговых систем.

Актуальность

	Алгоритмическая торговля сегодня занимает около 20% от общего объема торгов по всему миру. На некоторых биржах, таких как РТС FORTS и NYSE это значение достигает даже более 50% от общего дневного объема. [11]

	Срок жизни торговых систем ограничен не только свойствами торгового алгоритма, но также постоянно меняющимися условиями рынка. Согласно некоторым исследованиям срок жизни торговых стратегий составляет всего 1/8 того временного интервала для которого она составлялась.

	Исходя из этих фактов становится очевидной актуальность и перспектива исследования как построения, так оптимизации торговых систем и алгоритмов.

Задачи

	В данной работе поставлены следующие задачи:

Определить и исследовать подходы к оптимизации торговых алгоритмов

Исследование инструментов оптимизации

Выявление проблемных зон процесса оптимизации

Анализ возможных решений

Практическое исследование решений проблем оптимизации

Разработка алгоритма оптимизации торговых алгоритмов и критериев оценки надежности их работы




Глава 1. Основные принципы тестирования и оптимизации торговых алгоритмов

1.1 Определение понятия оптимизации торговых алгоритмов

	Оптимизация – это процесс настройки исходной торговой системы путем корректировки ее параметров и/или групп параметров. [4]

	Процесс оптимизации торговой стратегии представляет из себя перебор параметров внутри какого-либо временного диапазона исторических данных для конкретного финансового инструмента.

	Цель этого процесса – получение лучших результатов работы торговой системы для данных отрезка времени и финансового инструмента.

	Результат оптимизации характеризуется значениями индикаторов работы системы для каждого значения оптимизируемых параметров. То есть видно при каких значения получались те или иные результаты работы системы. Другими словами, для каждого набора параметров производится тестирование торговой системы на определенном промежутке исторических данных и представляются результаты этого тестирования.

1.2 Необходимость оптимизации

	Любой торговый алгоритм заключается в первую очередь в том, чтобы определить точки открытия и закрытия торговых позиций. Будь то анализ ситуации на рынке и оценка вероятностей направления движения цены, или любые случайные входы. Соответственно при любом изменении правил входа и выхода из позиции меняются и результаты работы торговой системы в целом. Также эффективность торгового алгоритма меняется в том числе и при изменении условий самого рынка и рыночных ситуаций. Это и создает предпосылки к оптимизации торговой системы для получения лучших результатов работы в текущем моменте или в ограниченном будущем.

	Под оптимизацией могут пониматься совершенно разные процедуры. Это может быть и учет особенностей финансового инструмента или его таймфрема (таймфрейм – это интервал времени группировки котировок при построении элемента ценового графика: бара, свечи или точки линейного графика) [8], условий торговли предоставляемых брокером, изменение самого торгового алгоритма системы, добавление всякого рода фильтров или нахождение значений параметров той системы, которая уже создана.

	Мы будем рассматривать все аспекты оптимизации, но для начала определим предпосылки оптимизации любой торговой системы:

Повышение стабильности работы системы для различных условий рынка

Повышение прибыльности торговой системы для различных финансовых инструментов

Повышение качества работы системы в текущих реалиях рынка

Для достижения каждой из описанных целей необходимо произвести оптимизацию существующей торговой системы, которая выполняется с использованием данных прошедших котировок. Процесс оптимизации заключается в переборе значений параметров системы с целью получения более прибыльных вариантов работы алгоритма, как описано выше, для выполнения подбора используются специальные программные средства.

 Рассмотрим какие инструменты существуют для оптимизации торговых систем сегодня.

1.3 Инструменты оптимизации

	Инструментами оптимизации представляются специальные программные продукты, которые имеют в себе встроенные инструменты описания торговых алгоритмов, выделения их параметров для оптимизации, а также средства тестирования и оптимизации этих алгоритмов. 

	Существует действительно большое количество различных подобных программных продуктов. Их многочисленность во многом обусловлена следующими факторами:

Множество различных торговых площадок. Доступ к определенным площадкам обеспечивается различными провайдерами, которые имеют различные API (интерфейс прикладного программирования) для предоставления электронного доступа к торгам.

Множество языков описания торговых систем. Некоторые системы имеют внутренние специальные языки для описания торговых алгоритмов, другие могут использовать стандартные, такие как Visual Basic, C#, Java и др.

Различные подходы описания торговых систем. Существует два кардинально различных подходов описания торговых алгоритмов: текстовый и графический. Графический создан для тех трейдеров, которые не владеют навыками программирования, в таких программах код описания торгового алгоритма генерируется автоматически.

Наиболее распространенные программные продукты для описания и оптимизации торговых систем:




Табл. 1

Средства описания и оптимизации торговых систем



	Так как метод оптимизации в каждой системе один и тот же, следовательно для решения конкретно наших задач исследования нам не важен сам программный продукт. Следовательно, в нашем выборе будут участвовать следующие параметры: доступность, удобность, знание языка описания алгоритмов, доступные торговые площадки.

	В исследование предложена программная платформа MetaTrader4. Это программное обеспечение распространяется бесплатно, имеет встроенный мощный объектно-ориентированный язык программирования, а также средства оптимизации со всеми необходимыми возможностями. Доступ торговых площадок ограничен только рынком Forex и CFD (Contract For Difference, который позволяет спекулировать на ценах продуктов, не покупая их) на все самые ликвидные акции (голубые фишки), фьючерсы и сырье, это не ограничивает наших возможностей исследования.

	Более того, этот продукт для описания торговых систем является самым популярным в этом направлении. Профессиональные разработчики автоматизированных торговых систем предпочитают именно MetaTrader4, как готовый продукт для алгоритмической торговли, сразу после стандартных языков программирования (Visual Basic, C#, C++, C, Delphi и т.д.). Более того, даже новая версия данного продукта MetaTrader5 до сих пор не достигла той же популярности.

1.4 Описание торговой платформы MetaTrader4

	По мнению многих трейдеров и брокеров, MetaTrader4 является одной из самых надежных, удобных и функциональных торговых платформ на сегодняшний день. Не смотря на то, что создана платформа специально под рынок Forex, она позволяет торговать также CFD контракты на ликвидные акции, фьючерсы и сырье.

	MetaTrader4 позволяет торговать одновременно разными контрактами на разных рынках, а также с помощью большого набора графических инструментов, делать полный технический анализ, прогнозировать ситуацию на рынке и планировать сделки.

	Более того, данная платформа имеет встроенный язык программирования торговых стратегий MetaQoutes Language 4. Этот язык позволяет существенно расширять функциональность платформы, персонализировать ее под личные стратегии и автоматизировать рутинные операции. Всего существует четыре вида программ, которые можно писать на языке MQL4:

Советники (Expert Advisor) – это по сути готовая механическая (автоматизированная) торговая система, которая позволяет анализировать рынок и совершать сделки согласно заложенному в ней торговому алгоритму. Этот советник при реализации может быть привязан к графику какого-либо финансового инструмента (а также к определенному таймфрейму) и работать только на нем. Советник считывает рыночную информацию при каждом тике и прогоняет новую информацию по всему алгоритму. Также советник может просто информировать пользователя о торговых сигналах.

Пользовательский индикатор (Custom Indicator). Помимо множества встроенных технических индикаторов, MQL4 позволяет писать собственные, основанные на пользовательских алгоритмах анализа рынка. Индикаторы могут только выводить графическую и текстовую информацию на график и не могут торговать.

Скрипт (Script) – по сути может иметь структуру советника, отличие состоит в том, что скрипты не срабатывают потиково, а лишь один раз исполняют алгоритм по запросу пользователя.

Библиотека (Library). Как уже говорилось выше, MQL4 – объектно-ориентированный язык программирования. Библиотеки позволяют хранить и распространять наборы пользовательских методов.

Для написания кодов на языке MQL4 используется встроенная среда разработки MetaEditor4. [11]

	В нашем исследовании будут рассмотрены только «советники», которые и позволяют описывать торговые алгоритмы и оценивать их эффективность на рынке, используя информацию о прошедших котировках.

	Тестирование и оптимизация торговых систем выполняются с помощью встроенного в MetaTrader4 «Тестера стратегий». Работа с ним будет описана в практической чести данного исследования. [16]

1.5 Этапы оптимизации

	Теперь нужно определить из каких операций состоит процесс оптимизации.

	Для того чтобы оптимизировать торговую стратегию предлагается выполнить следующие этапы:

Описать стратегию на языке программирования, который позволит выполнить ее оптимизацию в выбранной программной среде. В нашем случае это язык MQL4 в среде разработки MetaEditor 4. 

Далее следует подготовить написанную систему к тестированию. Подготовка заключается в том, что должны быть учтены все свойства выбранных торгового инструмента и таймфрейма для оптимизации. Это включает в себя размер спреда (разница между ценой покупки и продажи в каждый момент времени для какого-либо актива), размер пункта, возможные размеры контрактов, волатильность, для некоторых систем это может быть время работы торговых площадок.

Предварительное тестирование системы на работоспособность. На данном этапе могут быть выявлены участки кода с ошибками и недочеты в описании торгового алгоритма.

Выбор промежутка исторических данных для тестирования. Для каждой системы это могут быть разные по величине промежутки.

Выбор источника исторических данных. MetaTrader в этом плане не только одна из наиболее гибких систем, которая позволяет добавить в тестировщик стратегий любые данные извне, но также имеет своего надежного и бесплатного провайдера исторических данный MetaQuotes. Данные от MetaQuotes всегда актуальные и разработаны специально для системы MetaTrader, поэтому в работе будут использоваться они.

Выбор метода тестирования. Как уже говорилось, советник выполняет алгоритм при каждом тике. Но потиковое тестирование занимает большое количество данных, а также не гарантирует стопроцентную достоверность значений котировок для каждого тика в истории. Если система построена так, что работает только с уже сформированными барами истории, то можно выбрать тестирование по ценам закрытия, в таком случае тик будет приравнен к точке закрытия каждого бара истории выбранного таймфрейма.

Тестирование выбранной стратегии при определенных интервале исторических данных котировок и методе тестирования.

Подготовка системы для оптимизации, которая включает в себя определение участков и параметров для которых необходима оптимизация. Участки кода можно разделять операциями, условия выполнения которых будет зависеть от значения определенного параметра. Все параметры, значения которых будут оптимизироваться помечаются специальной меткой, которая обеспечивает доступ к ним для тестировщика стратегий.

Определение промежутков значений для оптимизируемых параметров. На данном этапе необходимо выбрать те возможные значения параметров, которые не будут давать абсурдные результаты. Также на данном этапе можно добавить определенные строчки кода в советник, которые позволят избегать проверки заранее неправильных комбинаций параметров. К примеру, при оптимизации стратегии связанной с пересечением скользящих средний, где период одной из средних больше чем у другой, не имеет смысла проверять те комбинации, где периоды равны или противоречат начальным условиям (то есть у скользящей средней с меньшим периодом будет проверяться то значение, при котором ее период окажется большим).

Этап оптимизации, в котором отражается ход оптимизации и результаты работы системы при каждой комбинации параметров, что позволяет вывить проблемные участки работы системы и, возможно, условия сокращения промежутков возможных значений параметров.

После окончания оптимизации, выбираются наиболее приемлемые показатели работы системы и затем необходимо снова протестировать ее уже с новыми значениями оптимизируемых параметров.

На последнем этапе оценивается устойчивость системы. Существует множество способов оценки надежности системы и определения значимости полученных значений параметров, которые будут рассмотренные ниже.

После окончания процесса оптимизации, желательно выполнить контрольное тестирование на исторических данных о котировках, чтобы убедиться, что программой не были допущены ошибки в котировках. А также протестировать рабочую системы в реальных условиях рынка. [22]

1.6 Проблемы оптимизации

	В рамках процесса оптимизации может возникнуть множество проблем на разных его этапах. Эти проблемы включают в себя как программный характер, так и человеческий фактор.

	Если говорить о программных проблемах, то наиболее проблемными являются такие зоны, как: время оптимизации, абсурдные результаты, скрытые ошибки в коде, а также ошибки в исторических данных о котировках. Рассмотрим их подробнее.



Время оптимизации на прямую зависит от количества параметров, интервалов их возможных значении и количества тиков в истории. MetaTrader4 имеет встроенный генетический алгоритм для оптимизации торговых систем, который позволяет сосредоточить зону поиска оптимальных значений только на тех ветвях комбинаций, которые дают лучшие значения для оптимизируемого показателя работы системы. Также в тестировщике стратегий можно указывать ограничения на показатели работы системы, которые прекратят тестировать конкретный набор параметров при выходе этих значений из зоны ограничений.

	

Абсурдные результаты часто возникают при отсутствии здравых и четко описанных ограничениях на возможных комбинациях параметров. Проблема в том, что система не может отделять такие результаты от остальных и выводит показатели системы вместе с остальными. Это значительно увеличивает время поиска оптимальных значений параметров после завершения процесса оптимизации.



Скрытые ошибки в коде программа сама по себе не может определить точность следования за стратегией, которую задумал автор. Часто получается так, что не учтены какие-либо мелкие возможные условия рынка и система выдает результаты для алгоритма, который не полностью соответствует задуманному.



Ошибки в котировках эту проблему нельзя избежать и предупредить, ее можно только учитывать при оценке работы системы. Ошибки в котировках существуют вне зависимости от источника данных, в любом случае невозможно полностью воспроизвести ситуацию на рынке для каждого тика в истории, что создает определенную погрешность в результатах работы системы.



Человеческий фактор включает в себя намного более широкий спектр возможных проблем в связи с присутствием эмоций и нерациональности при оценке работы системы. Список возможных трудностей может быть бесконечным, ниже приведены только самые распространенные и сложно преодолимые из них: 

Выбор непредставительного промежутка исторических данных для оптимизации. Как уже говорилось, для каждой системы и оптимизируемых параметров этот промежуток может быть разным, но выбор правильного часто представляет из себя далеко не тривиальную задачу.

Выделение слишком большого числа параметров и большого диапазона возможных значений для них. Это может привести к переоптимизации или подгонке к историческим данным. Это создает чересчур большой резонанс в работе системы в историческом интервале, в котором она оптимизировалась и за его пределами.

Субъективные оценка результатов работы системы, выбор оптимизированных значений параметров и прогнозирование работоспособности системы. При неправильном выборе параметров или переоценке надежности системы, или доверчивости к показателям ее работы при тестировании возникает вероятная проблема сильного отклонения эффективности системы от тех значений, которые она демонстрировала на исторических данных.

Стремление к идеальным показателям работы системы. Как следствие снова проявляется переоптимизация системы, то есть подгон ее работы под исторические данные. Оценка же «идеальности» работы системы полностью субъективна, что практически гарантирует непрогнозируемость работоспособности системы.

	 В этой части исследования были выделены наиболее острые и актуальные проблемы оптимизации торговых систем. Далее будет проведен их анализ и рекомендации по минимизации их влияния на процесс оптимизации и оценке работоспособности системы.

Выводы

	В этой главе было определено понятие оптимизации торговой системы, а также рассмотрены существующие методы и средства ее выполнения. Оговорены границы проводимого исследования.

	Теперь опишем конкретные задачи анализа существующих проблем и путей их решения, основанные на рассмотренном материале:

Анализ существующих возможностей минимизации человеческого фактора при выборе лучшего набора оптимизированных параметров

Анализ методов оценки устойчивости оптимизированной торговой системы

Анализ процесса тестирования готовых торговых систем и выявление проблемных зон


Глава 2. Методология оптимизации

2.1 Оценка результатов оптимизации

	Как уже было сказано, процесс оптимизации заключается в переборе значений параметров торгового алгоритма внутри какого-либо диапазона значений с целью повышения эффективности работы системы. Для каждого набора параметров производится тест торговой системы для определенного финансового инструмента, таймфрейма и временного промежутка исторических данных. Выходной информацией каждого такого тестирования являются значения определенных индикаторов качества работы системы. Исходя из их значений и определяется лучший набор параметров, который и будет оптимальным. [9]

	Следует описать эти индикаторы качества работы системы и определить их роль в процессе оптимизации:

Порядковый номер набора параметров. Служит своего рода именем того набора параметров, для которых был выполнен тест.

Чистая прибыль. Разница между общей прибылью и общим убытком. В системе автоматически не выводятся результаты, для которых значения этого параметра были отрицательные. Они отбрасываются как незначительные. Важность этого параметра незначительна без учета остальных, но его можно рассматривать как индикатор принципиальной работоспособности системы с данным набором параметров.

Прибыльность. Этот фактор рассчитывается как общая прибыль деленная на общий убыток. Данный показатель определяет величину разрыва между прибылью и убытками. Его можно учитывать, как один из основных показателей прибыльности системы. Также с его помощью можно отсеять абсурдные результаты, такие, например, для которых этот показатель выше 5. Так как такие системы заранее будут переоптимизированы, то есть подогнаны под исторические данные.

Математическое ожидание выигрыша равен чистой прибыли деленной на количество сделок. Производный параметр, который указывает среднюю прибыльность каждой отдельной сделки. Достаточно важный параметр, так как может помочь определить, как подходящие наборы параметров, так и незначительные. Его значение полностью зависит от величины торгуемого лота, и это следует учитывать при оценке эффективности работы системы.

Количество сделок. Этот параметр следует использовать для отсева незначительных наборов параметров, так как результаты сделок, число которых меньше 50, просто непрезентативные, потому что не имеют статистической обоснованности.

Максимальная просадка – самая большая разница между соседними локальными максимум и минимумом значения величины депозита в ходе тестирования.

Относительная просадка рассчитывается, как и максимальная просадка, но учитывает только величину депозита для закрытых сделок, не беря в расчет изменение баланса в ходе сделки. Для систем с фиксированными стоп-лоссом значения повторяют значения максимальной просадки и могут не учитываться.

Также для каждого набора параметров можно провести полное тестирование вручную, тогда будут выведены значения всех индикаторов работы системы. Они будут рассмотрены далее, при экспериментальном тестировании торговых систем.

Более того можно рассматривать график оптимизации, который показывает значения оптимизируемой величины (ей может являться любой из описанных факторов работы системы) для каждого номера набора параметров. Этот график можно просматривать в двумерной плоскости, выбрав значениями осей два любых оптимизируемых параметра. Тогда ячейки, образуемые возможными значениям этих параметров будут закрашиваться в зеленый цвет, оттенок которого будет темнее для той области наборов, где оптимизируемый параметр имеет более высокое или низкое значение, в зависимости от его сути. То есть для прибыльности при повышении значения, для просадки при снижении.

2.2 Методы оценки и повышения надежности торговой системы

	Стоит сразу оговориться, что под надежностью будет пониматься применимость торговой системы в реальных условиях рынка с допустимыми изменениями ее показателей в сравнении с теми, которые она показывала при тестировании.

	Это проблема наиболее актуальная на сегодняшний день, так как эффективность системы при оптимизации и при использовании в реальных условиях имеют очень большие отличия, что мешает оценке рисков, а также применению этой системы в целом. Так как при использовании ее, торговая система показывает совершенно другие результаты торговли.

	В исследовании будет предложен комплекс мероприятий оценки оптимизации и критериев работоспособности, и устойчивости системы, а также проверим их применимость в реальных условиях.

	Методы оценки работоспособности системы применяются на 11 и 12 этапах описанного выше плана оптимизации, которые соответствуют выбору наиболее эффективных значений оптимизируемых параметров и оценки устойчивости системы.

	Для начала следует определить необходимую последовательность операций оценки оптимизации:

Определение наиболее устойчивых значений параметров системы

Тестирование системы с оптимизированными параметрами и выбор лучших параметров на основе результатов тестирования

Оценка прогнозируемых результатов работы системы

Тестирование вне выборки

Прогнозирование временных границ работоспособности системы и оценка возможных отклонений показателей ее эффективности

Ниже приведено описание инструментов, которые позволят выполнить каждый из описанных этапов оптимизации.

2.2.1 Устойчивость значений параметров системы

	Под устойчивостью понимается незначительность отклонений показателей эффективности системы при изменении значений ее параметров.

	Как уже было сказано, при оптимизации системы строятся два графика результатов оптимизации. Первый из которых показывает значение оптимизируемого показателя в зависимости от номера прохода тестирования, а второй показывает относительную величину оптимизируемого показателя в зависимости от значений любой пары оптимизируемых параметров системы.

Для ясности приведем пример обоих графиков. На первом рисунке изображен график значения баланса (оптимизируемого критерия работы системы) от номера комбинации значений оптимизируемых параметров.



Рис.1

ось Х – номер набора параметров, ось Y - значение депозита

Если не применять генетический алгоритм оптимизации, то этот график поможет выбрать тот диапазон комбинаций значений параметров, которые дают меньшее отклонение оптимизируемого показателя в сравнении с соседними. На этом графике визуально можно определить такую область между 6000-8000 номерами комбинаций; для более точной оценки можно использовать эконометрические методы. Но, так как для сокращения времени оптимизации будет применен генетический алгоритм, этот график с точки зрения определения более устойчивых комбинаций для нас будет не информативен, так как при использовании генетического алгоритма, соседние номера комбинаций не гарантируют их последовательные значения.



Рис. 2

ось Х – значения параметра 2, ось Y - значение параметра 2

	На втором рисунке изображен второй тип графика, который показывает значения баланса для двух выбранных параметров в зависимости от их значений. Чем темнее область, тем выше значение баланса. Таким образом можно выбирать наиболее устойчивые комбинации пар параметров, которые при незначительном изменении их значений приводят к незначительным изменениям показателя работы системы. На этом графике можно легко визуально выделить такую область: 25-35 по оси X, 15-27 по оси Y. Перебирая все пары оптимизируемых параметров, можно получить те их диапазоны значений, которые будут являться наиболее устойчивыми для оптимизируемой системы.

2.2.2 Тестирование системы

	Далее для каждых наиболее надежных комбинаций параметров следует произвести тестирование системы, чтобы определить устойчивость и результативность ее работы на исторических данных. Результаты тестирований помогут определить наиболее эффективную комбинацию значений параметров, работоспособность которой будет оценена далее.

	При оценке результатов тестирования будут взяты во внимание оба аспекта результатов ее работы: график баланса (баланс – текущее значение величины депозита) и значения индикаторов ее эффективности.

	Для начала рассмотрим контроль формы графика баланса. График баланса – это график на плоскости, где по оси Х обозначены номера совершенных системой сделок, а по оси Y значения баланса и свободной маржи (свободные средства, не обремененные залогом для открытых позиций). Также строится гистограмма объемов сделок внизу графика (только для систем с изменяющимися объемами сделок).  Приведем критерии оценки формы графика баланса и их влияние на устойчивость системы:

Линейность. Чем более линейный график, и на нем отсутствуют визуальные локальные максимумы и минимумы, тем более устойчива и надежна система и тем стабильнее доход от каждой сделки.



Рис. 3

ось Х – номер сделки, ось Y - значение депозита

Просадки. Просадка – это разница между локальным максимумом значения баланса и следующим за ним локальным минимумом. Чем меньше визуальные просадки и чем они короче (баланс быстро возвращается к локальному максимуму), тем более надежна система.



Рис. 4

ось Х – номер сделки, ось Y - значение депозита

Флэты. Флэт – боковое движение графика баланса, оно характеризовано отсутствием прибыли или наращивания значения баланса. Чем они короче и чем их меньше – тем стабильнее работа системы.



Рис. 5

ось Х – номер сделки, ось Y - значение депозита

Локальные максимумы системы должны иметь восходящий характер. Другими словами, каждый новый максимум должен быть выше предыдущего. Это характеризует прибыльность системы.



Рис. 6

ось Х – номер сделки, ось Y - значение депозита

Тенденция на конец периода тестирования должна подтверждать прибыльность и устойчивость системы, так как последние результаты больше всего характеризуют поведение системы в приближенных к реальным условиях.



Рис. 7

ось Х – номер сделки, ось Y - значение депозита

При тестировании оптимизированных комбинаций для выбора наиболее надежной комбинации следует в первую очередь уделять вниманием таким критериям работы системы [22]:

Прибыльность. Ее значение должно быть выше 1,5. Для очень хороших систем, ее значение обычно равно 2 и более

Количество сделок. Чем больше сделок делает система при сохранении остальных показателей, таких как прибыльность, математическое ожидание выигрыша и просадки, тем лучше работает система, и тем более показательны значения ее индикаторов эффективности при тестировании.

Максимальная просадка, которая характеризует размер максимального снижения значения депозита до восстановления. Чем меньше этот показатель – тем надежнее система.

 Математическое ожидание выигрыша. Среднее значение каждой сделки системы. Чем выше – тем более прибыльная система.

Все эти индикаторы хорошо отображают реальную эффективность системы, но только в том случае, если она не подогнана под исторические данные (не переоптимизирована). Случаи переоптимизации будут выявлены на этапе тестирования вне выборки.

2.2.3 Прогнозируемые результаты работы системы

	Данный аспект оценки оптимизированных параметров включает в себя два свойства – стабильность и пессимистическое предположение.

	Под стабильностью понимается вероятность того, что счет во время работы сократиться в N раз. Например, считается критичным проседание величины депозита в 2 раза. Даже если при оптимизации была получена меньшая просадка – это не гарантирует того, что при реальной торговле такая величина просадки будет повторена. Для оценки же вероятности такого проседания существует критерий устойчивости системы POR (Probability of Ruin). Для контроля устойчивости системы нам понадобятся показатели следующих индикаторов работы системы: процент прибыльных сделок и отношение среднего выигрыша к среднему проигрышу. Ниже приведена таблица с вероятностями проседания баланса в 2 раза при работе системы в постоптимизационный период. [15]

Табл. 2

Таблица расчета значений показателя POR



	Применение этой таблицы сводится к следующим действиям:

Тестируется система в том же диапазоне, в котором она была оптимизирована

По оси Y отмечается ее прибыльность, по Х – процент прибыльных сделок

Далее смещается на одну ячейку в верх и на одну ячейку влево. 

Значение этой ячейки и будет вероятность проседания баланса в два раза при работе системы за границами выборки. Например, для системы с прибыльностью равной 2 и процентом прибыльных сделок 45%, вероятность проседания счета в два раза равна 50%.



Далее рассмотрим пессимистическую оценку работы показателей системы при реальной ее работе. Для пессимистической оценки системы существует показатель PROM (The pessimistic return on margin), который занижает прогнозируемую прибыль и завышает возможные убытки согласно стандартному статистическому отклонению. [15]



#WT – число прибыльных сделок

AW – средняя прибыль

#LT – число убыточных сделок

AL – средний убыток

Допустим во время теста системы были получены такие результаты: общая прибыль равна 2500$, убыток 1000$, а депозит был равен 1000$. Тогда получается, что на тесте система дала 150% дохода на депозит. PROM же оценит предположительный доход равным 73,3%. Именно на такой доход и следует опираться при оценке предполагаемой прибыльности системы.

В целом эти показатели помогу оценить рамки возможных изменений основных показателей системы, просадку и доходность. Но следует также зафиксировать грань возможных отклонений от нормы других показателей для того, чтобы наиболее точно определить пригодность системы в реальной торговле. 

2.2.4 Тестирование вне выборки

	Тестирование системы вне выборки позволит оценить отклонение прогнозируемых показателей системы от реально полученных. Работа системы за рамками оптимизационного периода – это представление реальных условий торговли, то есть торговли в реальном времени. [9]

	Оценка эффективности системы вне выборки будет произведена следующим образом:

Для системы, согласно ее показателям на оптимизационном отрезке будет определен процентный интервал возможных отклонений основных ее показателей. Например, если при оптимизации просадка составляла 20%, то следовательно максимальное возможное отклонение будет 25%. Это означает, что если просадка получится больше чем (20+20*0.25) % - то система не пригодна для реальной торговли.

Торговая система будет тестироваться с последовательным расширением временного горизонта постоптимизационного периода до определения той точки, в которой система становится неработоспособной.

Эта точка поможет рассчитать горизонт работоспособности системы

Оптимизируем системы на временном интервале равном по величине начальному, но уже до настоящего времени

Эта система и будет итоговой торговой системой, которую уже следует тестировать в реальных условиях на демо-счете.

2.2.5 Прогнозирование временных границ работоспособности системы и оценка возможных отклонений показателей ее эффективности

	После завершения всех этапов оптимизации и тестирования была получена готовая для работы в реальных условиях торговая система. Теперь следует определить временной горизонт ее работоспособности, возможные значения отклонения ее показателей, а также описать условия вывода системы из эксплуатации. [4, 9]

	Временной горизонт работоспособности системы, а также величина возможных отклонений были определены на предыдущих этапах тестирования. 

	Мы предлагаем оценивать временной горизонт работоспособности системы таким образом: оцененный временной горизонт – (оцененный временной горизонт * допущенное отклонение). Другими словами, если был оценен временной горизонт работоспособности равный одному году, то в реальной торговле система будет применяться всего 12*0.25, то есть 8 месяцев. После истечения этого периода, следует заново оптимизировать систему и оценить временной горизонт уже для новых оптимизированных значений параметров торговой системы.

	Возможные отклонения показателей были определены при тесте системы вне выборке. Также для учета работоспособности системы следует учитывать рассчитанные показатели POR и PROM.

Выводы

	В этой главе выполнен анализ процедур оптимизации и тестирования торговых систем. Также были определены методы, которые помогают объективно оценить работоспособность и надежность торговой системы, для исключения человеческого фактора в решении о применении и оценивании торговых систем.

	Более того, были выдвинуты гипотезы важности определенных индикаторов работы торговой системы и приведены инструменты их оценивания и прогнозирования значений.

	Исходя из проведенного анализа, была поставлена цель провести эксперимент построения и оценки реальной торговой системы, в процессе которого будут применены все описанные выше инструменты и спрогнозирована работоспособность такой системы.

	Результатом практической части этого исследования должен быть получен своего рода алгоритм оптимизации, тестирования и оценивания торговых систем, который позволит сократить степень эмоционального отношения к торговым системам при оценке рисков и прогнозировании их применимости в реальной торговле. 




Глава 3. Практическое исследование оптимизации торговых алгоритмов

	Исходя из рассмотрения теоритической части процесса оптимизации торговых алгоритмов, а также анализа его проблемных зон, была поставлена задача произвести практические описание, тестирование и оптимизацию торговой системы с целью определения возможных трудностей и возможностей применения тех методов, которые были описаны при анализе проблемных зон.

	В результате стоит цель получить алгоритм оптимизации, тестирования и оценки торговых систем для применения в реальной практике.

3.1 Описание торгового алгоритма

	При выборе торговой стратегии учитывались такие факторы, как:

Популярность инструментов, применяемых в этой стратегии

Опыт использования этой стратегии трейдерами, для подтверждения ее эффективность

Применимость данной стратегии на различных рынках

Возможность выделить в ней различные оптимизационные параметры

	В результате анализа существующих стратегий, была выбрана та, которая основана на экспоненциальной скользящей	средней.

	Стратегия называется «Окно МА» (http://strategy4you.ru/strategii-foreks-na-osnove-skolzyashhix-srednix/strategy-forex-okno-ma.html), ее автором является опытный трейдер Алексей Лобода. Стратегия была найдена на портале  [13]. Готовый код стратегии платный, но на основе ее описания, был разработан советник, который торгует по алгоритму, описанному ниже.

На графике котировок строится экспоненциальная скользящая средняя [8]

Если ценовая свеча пробивает скользящую среднюю снизу вверх и последующие несколько свечей (больше 5) закрываются выше скользящей средней, то при откате цены к средней, открывается сделка на покупку. На продажу действуют обратные условия.

Стоп-лосс устанавливается на фиксированном расстоянии от открытия

Тейк-профит устанавливается на фиксированном расстоянии от открытия и должен быть меньше чем стоп-лосс

Как только цена приближается к тейк-профиту на определенное количество пунктов, стоп-лосс переносится в безубыток

3.2 Описание финансовых инструментов

	Из всего спектра возможных финансовых инструментов, были взяты по одному представителю каждого доступного типа. [15]

Валютная пара EUR/USD. Размер контакта 100000 единиц, тик 0.0001.

Акции Сбербанка. Размер контракта 20 акций, тик 0.01

Срочные контракты на золото. Размер контракта 100 тройских унций, тик 0.1.

Фьючерсы на природный газ. Размер контракта 10000 кубических метров, тик 0.001

3.3 Описание и тестирование торговой стратегии

	Торговая стратегия была описана на языке MQL4, ниже приведен текст кода с комментариями [18]:



Рис. 8



Рис. 9



Рис. 10



	До оптимизации протестируем систему с теми значениями параметров, которые рекомендует ее автор для каждого выбранного торгового инструмента и для разных таймфреймов. Таймфреймы были выбраны только те, которые имеют показательные различия: 15 мин, час, день.

	Тестирование было произведено со следующими значениями параметров, рекомендованными автором для валютной пары EUR/USD на 15 минутном графике:

Период экспоненциальной скользящей средней равен 8

Стоп-лосс равен 70 пунктам

Тейк-профит равен 60 пунктам

Стоп-лосс переносится в безубыток при приближении цены к тейк-профиту на 5 пунктов

Количество свечей, которые учитываются в торговом сигнале равно 15

При всем этом, не учитывались особенности финансовых инструментов, а также таймфреймов. Сделки открывались только с фиксированным минимальным лотом, который равен 1% от минимального контракта, при этом размер депозита равен 1000$

	Размер временного диапазона тестирования изменялся в зависимости от таймфрейма:

15 мин – 2 месяца

60 мин – полгода

День – 8 лет

Результаты тестирования:

EUR/USD 15 мин



Рис. 11

EUR/USD 60 мин



Рис. 12

EUR/USD 1 день



Рис. 13



NG (Natural Gas) 15 мин



Рис. 14

NG (Natural Gas) 60 мин



Рис. 15

NG (Natural Gas) 1 день



Рис. 16

Gold 15 мин



Рис. 17

Gold 60 мин

Рис. 18

Gold 1 день



Рис. 19

SBER 15 мин



Рис. 20

SBER 60 мин



Рис. 21









SBER 1 день



Рис. 22

	Из результатов тестирование очевидно не только присутствие ощутимой разницы работы системы на различных финансовых инструментах, но также и значительное расхождение при разных таймфреймах на одном и том же торговом инструменте.

	Из этого следует, что данная система действительно нуждается в оптимизации, а также в адаптации к каждому отдельному финансовому инструменту. Так как на каждом торгуемом инструменте существенно различны минимальные объемы торговли, а также величина пункта и тика.

	Так как тест продемонстрировал действительные отличия в работе системы для разных инструментов, что говорит о различности в их сущностях. Система будет оптимизирована под два финансовых инструмента, чтобы исследовать существующие отличия и определить опытным путем способы адаптации системы. Были выбраны следующие торговые инструменты: валютная пара EUR/USD и фьючерсы на золото.

3.4 Параметры оптимизации

	Перед тем как определить параметры для оптимизации всей системы на каждом финансовом инструменте, следует адаптировать ее для работы на срочных контрактах на золото GOLD.

	Торговый алгоритм «Окно МА» был разработан для валютной пары EUR/USD и в адаптации к этому инструменту не нуждается. Рассмотрим отличия данных инструментов для того, чтобы определить какие части системы нуждаются в адаптации:



Табл. 3

Различия в торговых инструментах: золоте и пары EUR/USD



	Согласно этой таблице, следует внести следующие поправки в алгоритм при адаптации его к торговле фьючерсами на золото:

Учет разной величины спреда, что значит, что нужно внести поправки к возможной разнице между уровнями тейк-профита и стоп-лосса, чтобы при том же алгоритме не было столько различных результатов

Учет минимального уровня отложенных приказов, что ограничивает снизу величину тейк-профитов и стоп-лоссов. Также это ограничивает сверху ту величину, которая регулирует необходимое расстояние до тейк-профита, при которой стоп-лосс переносится в безубыток

В связи с данными поправками в систему был добавлен следующий код:

При невыполнении условия того, что уровни тейк и стоп приказов находятся дальше от цены сделки больше чем на 5 пунктов, сделки не выполняются

Были смешены уровни тейк-профита на разницу в спреде торговых инструментов (на 4 пункта)

Внеся данные изменения был проведен повторный тест системы с теми же значениями параметров на том же временном промежутке для таймфрейма равного 15 минутам:



Рис. 23

	Как видно, после адаптации изменились следующие показатели системы:

Уменьшились абсолютная и относительная просадки

Увеличилась прибыльность

Увеличилась прибыль

Увеличилось математическое ожидание выигрыша

Результат работы системы также сменился с отрицательного на положительный.

	Теперь необходимо провести грубую оптимизацию, для оценки возможных диапазонов значений параметров для каждого финансового инструмента. Оптимизируемые параметры и их интервалы значений приведены ниже:

Период экспоненциальной скользящей средней от 5 до 100 с шагом 5

Уровень стоп-лосса от 40 до 200 с шагом 10

Уровень тейк-профита от 30 до 190 с шагом 10

Расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток от 5 до 30 с шагом 5

Таймфреймы 15 мин, 60 мин, 1440 мин (1 день)

Количество баров, которые учитывают в сигнале от 5 до 25 с шагом 5

Системы будут оптимизированы только для того таймфрейма, который рекомендует автор торговой системы – 15 мин. Временные рамки оптимизации выберем 6 месяцев.

По результатам проведенной оптимизации, были наложены следующие ограничения на оптимизируемые параметры:

Были отброшены все результаты, где тейк-профит меньше стоп-лосса более чем в два раза, в связи с нестабильностью таких торговых условий

Ограничены диапазоны возможных значений параметров:

Для золота

Период экспоненциальной средней от 10 до 60

Количество баров, которые учитываются в сигнале от 15 до 20

Расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток остается от 5 до 30

Стоп-лосс и тейк-профит от 60 до 180

Для валютной пары EUR/USD

Период экспоненциальной средней от 5 до 15 (для такого маленького диапазона уменьшим для точности шаг до 1)

Количество баров, которые учитываются в сигнале от 10 до 25

Расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток остается от 5 до 30

Стоп-лосс и тейк профит от 110 до 200

Разница в полученных различных ограничениях на возможные значения параметров подтверждают различные условия для работы системы на разных финансовых инструментах, а также необходимость оптимизации торгового алгоритма под каждый из них.

3.5 Оптимизация торгового алгоритма

	Теперь торговый алгоритм следует оптимизировать, согласно плану описанному ранее, а также с применением тех методов оценки лучших значений для оптимизируемых параметров, которые были рассмотрены в предыдущей главе.

	Все шаги оптимизации будут выполнены параллельно для каждого из выбранных торговых инструментов, для фиксации возможной разницы в эффективности методов выбора наилучших результатов оптимизации. На выходе будут получены оптимизированные торговые системы для каждого торгового инструмента и оценена их работоспособность, а также временные горизонты пригодности в реальной торговле.

	Тестовым окном оптимизации был выбран временной промежуток с 1.01.2012 по 01.07.2012 для того чтобы была возможность оценить горизонт применимости торговых систем, используя исторические данные котировок вплоть до сегодняшнего дня, то есть еще 10 месяцев.

	При анализе результатов оптимизации, будут отбрасываться как незначительные те результаты, в которых количество сделок меньше чем половина максимального количества сделок, и для которых прибыльность системы больше 2,5. Так как такие результаты заранее проявляют себя, как подогнанные под историю котировок.

3.5.1 Оптимизация торгового алгоритма для золота

	Графики оптимизации торговой системы для золота в период с 1.01.2012 по 01.07.2012:

Период экспоненциальной скользящей средней (ось Х) / расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток (ось Y)



Рис. 24

Количество баров, которые учитываются в сигнале (ось Х) / расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток (ось Y)



Рис. 25

Стоп-лосс (ось Х) / тейк профит (осьY)



Рис. 26

	Исходя из графиков определим наиболее устойчивые значения оптимизируемых параметров:

Период экспоненциальной скользящей средней 10-20

Количество баров, учитываемы при сигнале 15-20

Расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток 5-30

Стоп-лосс 60-140

Тейк-профит 100-170



Согласно всем ограничениям, а также с самым большим количеством сделок и минимальной просадкой лучшими оказались следующие параметры:

Период экспоненциальной скользящей средней - 10

Количество баров, учитываемы при сигнале - 20

Расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток - 110

Стоп-лосс - 70

Тейк-профит – 100

3.5.2 Оптимизация торгового алгоритма для EUR/USD

	Графики оптимизации торговой системы для пары EUR/USD в период с 1.01.2012 по 01.07.2012:

Период экспоненциальной скользящей средней (ось Х) / расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток (ось Y)



Рис. 24

Количество баров, которые учитываются в сигнале (ось Х) / расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток (ось Y)



Рис. 25

Стоп-лосс (ось Х) / тейк профит (осьY)



Рис. 26

	Исходя из графиков определим наиболее устойчивые значения оптимизируемых параметров:

Период экспоненциальной скользящей средней 6-8

Количество баров, учитываемы при сигнале 20

Расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток 5-30

Стоп-лосс 160-200

Тейк-профит 180-200

Согласно всем ограничениям, а также с самым большим количеством сделок и минимальной просадкой лучшими оказались следующие параметры:

Период экспоненциальной скользящей средней - 7

Количество баров, учитываемы при сигнале - 20

Расстояние до тейк-профита, при котором стоп-лосс переносится в безубыток - 5

Стоп-лосс - 200

Тейк-профит – 190

Результаты показали во многом различные значения параметров системы при оптимизации, за исключением параметра количества баров, учитываемых в сигнале. Поэтому далее этот параметр будет убран из списка оптимизируемых, зафиксировав его значение равным 20.

	Заметим при этом, что значения параметров для пары EUR/USD практически равны рекомендуемым автором системы, за исключением размеров стоп-лосса и тейк-профита. Для золота же остальные параметры сильно отличаются, что еще раз говорит о разной сущности торговых инструментов и необходимость оптимизации торговых систем для каждого из них.

3.5.3 Тестирование и определение устойчивости торговой системы для золота

	Протестируем систему с оптимальными значениями параметров, найденными при оптимизации, на том же тестовом окне. Проанализируем ее показатели, согласно описанным методам оценки работоспособности и надежности системы.

	Для начала рассмотрим форму графика баланса по тем ее свойствам, которые определяют качество работы торговой системы.



Рис. 27

ось Х – номер сделки, ось Y - значение депозита

Линейность. График довольно линеен, угол его наклона сохраняется постоянным на протяжении всего тестового диапазона, что характеризуем надежность и стабильность системы.

Просадки. Визуально можно легко определить наличие просадок на графике, но значение баланса быстро возвращается к локальным максимам за 1-4 сделки.

Флэты. Флэты на графике присутствуют, но при детальном рассмотрении, внутри каждого флэта локальные максимумы имели восходящую тенденцию. Следовательно, внутри флэтов, баланс стремился вернуться к локальному максимуму.

Локальные максимумы системы в целом имеют восходящую тенденцию.

На конец тестового периода график не изменяет наклон и характер своего движения, что говорит о том, что торговый алгоритм скорее всего подтвердит свою эффективность и вне тестового диапазона.

Теперь рассмотрим основные индикаторы работы системы, а также те, которые позволят рассчитать значения POR и PROM:

Прибыльность – 1.92

Количество сделок -85

Максимальная просадка (%) – 30.37 (2.47%)

Матожидание выигрыша – 2.82

Средняя прибыльная сделка – 10

Средняя убыточная сделка – 7.45

Количество прибыльных сделок (% от всего) -50 (58.82%)

Количество убыточных сделок (% от всего) – 35 (41.18%)

Имея эти значения, рассчитаем показатели POR и PROM для нашей системы при торговле на золоте.

Прибыльность и процент прибыльных сделок округлим до значений к ближайшим в таблице 2 и 60% соответственно. Тогда вероятность проседания счета в два раза будет равна 0, что говорит о высокой надежности системы при работе вне тестового окна.

Теперь рассчитаем показатель PROM:



При этом обычная доходность равна 23.9%

Как видно пессимистичный доход меньше реального всего в два раза, это говорит о достаточно высоком потенциале системы в будущем.

3.5.4 Тестирование и определение устойчивости торговой системы для пары EUR/USD

	Как и для золота протестируем систему с оптимальными значениями параметров на том же тестовом окне и оценим результаты работы нашего торгового алгоритма для валютной пары EUR/USD.

Оценим график баланса:



Рис. 28

ось Х – номер сделки, ось Y - значение депозита

Линейность. График имеет постоянный положительны наклон, что характеризует систему как стабильно прибыльную

Просадки. Присутствуют визуальные просадки. Просадки небольшие по величине и цена быстро возвращается к локальному максимум за 1-2 сделки

Флэты. В середине графика присутствует флэт, но нужно заметить, что немного, но в нем повышались локальные максимумы

Локальные максимумы в целом имеют восходящую направленность, что говорит о том, что на всем промежутке тестирования система наращивала значение депозита

Тенденция положительного движения, а также наклон линии баланса подтверждает работоспособность системы на постоптимизационном периоде.

Основные показатели работы системы:

Прибыльность – 2

Количество сделок -50

Максимальная просадка (%) – 8.40 (0.82%)

Матожидание выигрыша – 0.63

Средняя прибыльная сделка – 1.8

Средняя убыточная сделка – 2.1

Количество прибыльных сделок (% от всего) -35 (70%)

Количество убыточных сделок (% от всего) – 15 (30%)

Согласно показателям работы системы, вероятно проседания депозита в два раза равна 0.

Пессимистичная доходность равна:



Обычная же доходность составила 3.1%

В случае валютной пары EUR/USD разница между реальной и пессимистичной доходностью системы не столь велика, как для золота. В целом, система характеризует себя весьма надежной.

Разница в величине прибыли системы для золота и валютной пары EUR/USD охарактеризована различной стоимостью покупки финансового инструмента и стоимостью пункта изменения цены. А значит при похожей волатильности, система дает столь разные прибыли и просадки. Не смотря на это, торгуемый лот будет равным для обоих инструментов, так как цель исследования – изучение процесса оптимизации, определение способов повышения надежности системы и оценка работоспособности оптимизированного торгового алгоритма.

В реальных же условиях, согласно просадке, торгуемый лот для EUR/USD можно увеличить в 10 раз, не снизив надежность системы до критического уровня.

3.5.5 Тестирование торговой системы вне выборки для золота

	Перед тестированием торгового алгоритма для обоих финансовых инструментов, следует зафиксировать величину возможных отклонений показателей системы. 

	Так как торгуемый лот не был изменен, следовательно определять возможные отклонения, отталкиваясь от величины просадки, как индикатора рискованности торгового алгоритма, не представляется возможным. Поэтому данная величина зафиксирована на уровне, рекомендованном во многих статьях об оптимизации торговых систем равной 20%.

	Тогда для золота получаем наихудшие значения для основных индикаторов работы системы:

Прибыльность – 1.92*0.8 = 1.54

Максимальная просадка (%) – 30.37*1.2 = 36.44

Матожидание выигрыша – 2.82*0.8 = 2.26

Далее следует зафиксировать шаг увеличения диапазона тестового окна вне выборки. Так как был выбран достаточно небольшой диапазон для тестирования, данный шаг зафиксирован равным 2 месяцам.

Теперь проведем тестирование системы на периоде, начало которого в точке окончания оптимизации и постепенным увеличением окна на 2 месяца. Диапазон времени оптимизации был с 01.01.2012 по 01.07.2012, тогда тестирование вне выборки начинается с 01.07.2012 по 01.09.2012 и далее:

Основные показатели тестирования торговой системы на золоте с 01.07.2012 оп 01.09.2012:

Прибыльность – 1.67

Максимальная просадка (%) – 29.74

Матожидание выигрыша – 2.36

Основные показатели тестирования торговой системы на золоте с 01.07.2012 оп 01.11.2012:

Прибыльность – 1.20

Максимальная просадка (%) – 57.94

Матожидание выигрыша – 0.77



Как видно, на втором шаге, показатели системы отклонились более чем на 20%, теперь сделаем шаг назад и протестируем систему на промежутке в 3 месяца, для того, чтобы точнее определить горизонт применимости системы:

Основные показатели тестирования торговой системы на золоте с 01.07.2012 оп 01.10.2012:

Прибыльность – 1.25

Максимальная просадка (%) – 57.54

Матожидание выигрыша – 0.99	

Следовательно, горизонт применимости такой системы составляет два месяца.

3.5.5 Тестирование торговой системы вне выборки для EUR/USD

	Теперь проведем подобное тестирование для определения горизонта применимости торговой системы для валютной пары EUR/USD.

	Для начала зафиксируем рамки максимального отклонения показателей системы:

Прибыльность – 2*0.8 = 1.6

Максимальная просадка (%) – 8.40*1.2 = 10.08

Матожидание выигрыша – 0.63*0.8 = 0.5

И протестируем систему за пределами выборки:

Основные показатели тестирования торговой системы на EUR/USD с 01.07.2012 оп 01.09.2012:

Прибыльность – 1.61

Максимальная просадка (%) – 8.28

Матожидание выигрыша – 0.55

Основные показатели тестирования торговой системы на EUR/USD с 01.07.2012 оп 01.11.2012:

Прибыльность – 1.19

Максимальная просадка (%) – 8.48

Матожидание выигрыша – 0.17



Получаем, что на 4 месяцах система уже не пригодна, протестируем ее для 3 месяцев, для того, чтобы зафиксировать более точные временные границы возможной работоспособности системы:

Прибыльность – 1.12

Максимальная просадка (%) – 8.28

Матожидание выигрыша – 0.11

Следовательно, система применима только в первые два месяца за временным окном оптимизации.

	Из полученных результатов следует предположение, что горизонт применимости слабо зависит от финансового инструмента, а также от качества оптимизации. Скорее всего, зависит это от самой структуры и сути торгового алгоритма, которые по его внутренним свойствам характеризуют разницу его результатов вне границ диапазона оптимизации.

3.5.6 Оценка границ применимости торгового алгоритма и оценка его результативности

	При тестировании системы для обоих инструментов вне выборки, были получены одинаковые горизонты работоспособности системы равные двум месяцам стабильной работы. Теперь следует определить справедливость показателей POR и PROM для того, чтобы узнать возможно ли их применение к данному торговому алгоритму для прогнозирования рисков и прибыльности.

	По сути этих показателей, следует протестировать систему вне выборки на промежутке времени равном диапазону оптимизации и для их показателей посмотреть проседал ли депозит в 2 раза и более, а также оценить их прибыльность, чтобы сравнить с оцененной.

Тестирование системы для золота на промежутке с 01.07.2012 по 01.01.2013

Просадка составила 9.46%

Прибыль составила -0.2%

Тестирование системы для EUR/USD на промежутке с 01.07.2012 по 01.01.2013

Просадка составила 1.47%

Прибыль составила 0.3%

Следовательно, показатель PROM не применим к данному алгоритму, или же промежуток оптимизации был слишком мал, так как суть показателя PROM – оценка годового возврата на депозит. 

Просадка же депозита не составила 50% ни в одном из случаев, следовательно индикатор надежности POR оправдал себя в применении к данной системе и будет учитываться для расчета рисков в реальных условиях.

3.6 Проверка результатов оптимизации в реальных условиях

	Торговый алгоритм был оптимизирован для двух финансовых инструментов, а также был определен горизонт применимости торговой системы. Теперь согласно методу оценки горизонта применимости следует ввести погрешность равную 20%, тогда получается, что реальный горизонт работоспособности систем составляет примерно 48 дней (включая выходные дни).

	Теперь будет произведен процесс оптимизации также на полугодовом промежутке исторических данных, а затем проверить соответствие работы системы оценочным на следующих 48 днях.

	Временной промежуток оптимизации выберем следующий: с 01.07.2012 по 01.01.2013, а горизонт проверки следовательно будет с 01.01.2013 по 18.02.2013.

	Процесс оптимизации описан не будет, приведены сразу результаты тестирования системы с лучшими наборами параметров для обоих финансовых инструментов и рассчитаны показатель POR, а также максимально возможные отклонения основных показателей системы:

Золото

Прибыльность – 1.95

Количество сделок -43

Максимальная просадка (%) – 65.87 (6.03%)

Матожидание выигрыша – 5.94

Средняя прибыльная сделка – 17.43

Средняя убыточная сделка – 20.59

Количество прибыльных сделок (% от всего) -30 (69.77%)

Количество убыточных сделок (% от всего) – 13 (30.23%)

Вероятность проседания счета в 2 раза равна 0

EUR/USD

Прибыльность – 1.62

Количество сделок - 18

Максимальная просадка (%) – 6.03 (0.60%)

Матожидание выигрыша – 0.43

Средняя прибыльная сделка – 1.70

Средняя убыточная сделка – 2.09

Количество прибыльных сделок (% от всего) -12 (66.7%)

Количество убыточных сделок (% от всего) – 6 (33.3%)

Вероятность проседания счета в 2 раза равна 1%

Исходя из результатов следует определить максимально возможное отклонение основных индикаторов работы системы для обоих торговых инструментов:

Золото

Прибыльность – 1.95*0.8 = 1.56

Максимальная просадка (%) – 65.87*1.2 = 79.04

Матожидание выигрыша – 5.94*0.8 = 4.8

EUR/USD

Прибыльность – 1.62*0.8 = 1.3

Максимальная просадка (%) – 6.03*1.2 = 7.24

Матожидание выигрыша – 0.43*0.8 = 0.34

Результаты тестирования торгового алгоритма для обоих финансовых инструментов на промежутке исторических данных с 01.01.2013 по 18.02.2013:

Золото

Прибыльность – 1.58

Максимальная просадка (%) – 65.87*1.2 = 66.17

Матожидание выигрыша – 5.94*0.8 = 4.91

EUR/USD

Прибыльность – 2.4

Максимальная просадка (%) – 2.83 

Матожидание выигрыша – 0.74

Просадка депозита при использовании системы полгода за пределами оптимизационного периода составила:

Для золота – 6.05%

Для EUR/USD – 0.28%

Следовательно, рискованность использования системы подтвердила практическое отсутствие вероятности просадки депозита в два раза и более при использовании данной системы в реальной торговле.

3.7 Рекомендации по подходу к оптимизации и порядку ее выполнения

	Согласно проведенному исследованию, были подтверждены применимость и эффективность описанного выше подхода к оптимизации, а также почти всех методов прогнозирования поведения системы. На практике была подтверждена возможность оценки работы системы за горизонтами оптимизационной выборки.

	Исходя из всего сказанного и полученных результатов далее будут приведены рекомендации касательно подхода к процессу оптимизации и алгоритма его выполнения.

	

	При подготовке торгового алгоритма к оптимизации следует учитывать для какого финансового инструмента, а также для какого таймфрейма был разработан данный алгоритм. Так как автор при его разработке учитывал определенные свойства торгового инструмента и временного аспекта торговли. Более того, при оптимизации алгоритма стоит учитывать и значения его параметров, которые рекомендует автор системы.

	Следует проверить применимость данного торгового алгоритма на других финансовых инструментах, но для того, чтобы результаты были сравнимы, нужно привести его к подобному, но уже с учетом свойств нового торгового инструмента: 

Размер пункта

Цена пункта

Волатильность

Минимальные уровни отложенных приказов

Так как без учета этих свойств торгового инструмента, алгоритм может давать случайные результаты.

	Также оптимизацию следует проводить только для выбранного таймфрейма. Если же рассматривать несколько таймфреймов то только в серии отдельных оптимизаций. Это обусловлено тем, что в каждом отдельном таймфрейме одного и того же торгового инструмента будет разная волатильность. Более того, если оптимизировать с подборкой лучшего таймфрейма, то для каждого из них будет разные объем и точность исторических данных и эту погрешность надо тоже учитывать. Например, для 15 минутного графика может хранится 3-х летняя история с точностью 90%, для часового 5-ти летняя, для дневного 20-ти летняя. И тогда при оптимизации на выборке в 5 лет будут значительные различия в эффективности и надежности торгового алгоритма для разных таймфреймов.

При оценке результатов оптимизации нужно руководствоваться только объективными результатами и четкими правилами, исключая любую возможность эмоционального выбора. И для любого оптимизированного алгоритма следует определить, с учетом его свойств, коэффициент погрешности в эффективности, и протестировать для подтверждения оценки вне оптимизационного диапазона данных.

В практическом исследовании была подтверждена эффективность порядка оптимизации тем, что на выходе получили систему с оцененной эффективностью, поведение которой было определено. Но показатель доходности PROM не продемонстрировал при этом свою надежность. Возможно это обусловлено свойствами выбранного торгового алгоритма или величиной оптимизационного тестового окна. В любом случае при расчете этого параметра учитывается доходность за весь период оптимизационного диапазона времени, а значит, чтобы проверить доходность, надо, чтобы алгоритм проработал еще столько же времени вне выборки. Если временной горизонт работоспособности торговой системы меньше, то применение этого показателя не оправдано.

	Теперь приведем рекомендуемый алгоритм оптимизации торгового алгоритма, согласно результатам проведенного исследования:



Рис. 29

	В левом столбце описаны этапы подготовки торгового алгоритма оптимизации, если все этапы пройдены – то следует приступать к самому процессу оптимизации. Опишем подробнее каждый шаг данного алгоритма:

Выбор среды оптимизации и описание торгового алгоритма на языке, с которым работает данное программное обеспечение

Тестирование системы на ошибки в описании торгового алгоритма. Если выявлены ошибки – то в код алгоритма вносятся соответствующие правки и проверка повторяется

Алгоритм адаптируется к торговому инструменту с учетом его свойств

Система тестируется с учтенными свойствами, что позволяет выбрать параметры оптимизации и проверить точности исторических данных на «дыры»

Проверяются исторические данные. Если присутствуют «дыры» - то данные импортируются из стороннего источника

Выделяются параметры оптимизации и фиксируются максимально возможные диапазоны их значений

Предварительная оптимизация, которая позволяет сузить диапазоны возможных значений оптимизационных параметров. Если устойчивые комбинации не найдены, то расширяется диапазон на предыдущем шаге

Определяется диапазон возможных значений параметров с учетом результатов предварительной оптимизации

Фиксируются условия значимости результатов оптимизации. В нашем примере это были например максимальная разница стоп-лосса и тейк-профита, а также прибыльность системы больше 2.5 и меньше 1.5

Оптимизация торгового алгоритма

Оценка результатов оптимизации и выбор диапазона наиболее устойчивых значений параметров оптимизации

В определенном диапазоне ищутся оптимальные значения с максимальной прибылью и минимальной просадкой. Если таких нет, следует расширить диапазон на предыдущем этапе.

Тестирование системы с оптимальными параметрами на диапазоне оптимизации

Оценка результатов тестирования и проверка надежности системы. Если система ненадежна – следует вернуться к поиску оптимальных параметров

Фиксация коэффициента погрешности в прогнозируемой работе системы с учетом результатов тестирования и показателей эффективности и надежности системы

Тестирование торговой системы вне выборки. Если тестирование не подтверждает работоспособность системы, то следует вернуться на этап поиска оптимальных значений параметров

Оценка горизонта работоспособности производится с учетом результатов теста торгового алгоритма вне выборки. Если горизонт слишком мал, то с этого этапа следует вернуться на рассмотрение качества подготовки к оптимизации на этап предварительной оптимизации

Если все этапы пройдены успешно, то система готова к проверке в реальных условиях

Выводы

	В практической части данного исследования на реальном примере были проверенны описанные методы оптимизации и оценки торговой системы. Также были выявлены проблемные зоны и сделаны предположения по минимизации их влияния.

	Были рассмотрены процессы описания, тестирования, адаптации и оптимизации торговой системы, подход к которым оправдал себя показанной результативностью.

	В конце этой главы были не только даны рекомендации касательно подхода к оптимизации, но и представлен готовый алгоритм, который подтвердил свою эффективность и может быть применим в реальных условиях.

Заключение

	В ходе данной работы были решены все задачи, поставленные перед данным исследованием. Были установлены и проанализированы подходы к оптимизации, а также выбран наиболее объективный подход к определению ее эффективности. Также рассмотрены инструменты оптимизации и их основные свойства. Данное исследование определило основные проблемные зоны, а также возможности их преодоления и минимизации их влияния на результаты процесса оптимизации. На практике были проверены все предположения, касательно рассматриваемой проблемы и, исходя из полученных результатов, были даны рекомендации касательно подхода и порядка выполнения оптимизации торговых алгоритмов.

	На выходе было получено руководство эффективной оптимизации торговых систем, которое может быть применимо на практике при построении своей торговой системы. Также данное исследование может применяться во всех аспектах алгоритмической торговли на финансовых рынках, которые напрямую связаны с построением и оптимизацией торговых алгоритмов.

	Более того данная работа может позволить сократить степень влияния человеческого фактора при выборе оптимальной торговой стратегии, что позволит избежать многих ошибок при выборе оптимальных параметров.

	В перспективе следует рассмотреть аспекты, расширяющие применимость и надежность результатов данного исследования, а именно:

Определение влияния размера диапазона оптимизации на горизонт применимости торговых стратегий

Более точная оценка рисков и доходности системы на постоптимизационном периоде

Более четкие правила выбора и проверки оптимальных параметров системы

Результатом изучения данных аспектов может стать более надежный алгоритм оптимизации, а также более обширные и объективные рекомендации, касательно подготовки и реализации процесса оптимизации торговых алгоритмов.




Список использованной литературы

Биржевые секреты. Технический анализ / Д. Швагер; Пер. с англ. – М.: Бизнес&Успех, 2009. – 384 с.

Дейтрейдинг на рынке Forex: Стратегии извлечения прибыли / Кетти Лин; Пер. с англ. – 4-е изд. – М.: Альпина Паблишерз, 2011. – 237 с. 

Долгосрочные секреты краткосрочной торговли. / Ларри Вильямс; Пер. с англ. – СПБ.: Питер, 2010. – 256с.

Механические торговые системы: Психология трейдинга и технический анализ / Ричард Вайсман; Пер. с англ. - М.: Альпина Паблишерз, 2011. – 229 с.

Технический анализ фьючерсных рынков. Теория и практика / Джон Дж. Мерфи; Пер. с англ. – М.: Альпина Паблишерз, 2011. – 616 с.

Торговые роботы на российском фондовом рынке / Ю. Чеботарев. – М.: SmartBook, 2011. – 160 с.

Торговые стратегии с высокой вероятностью успеха. Тактики входа и выхода на рынках акций, фьючерсов / Роберт Майнер; Пер. с англ. – М.: Альпина Паблишерз, 2012. – 330 с.

Трейдинг с доктором Элдером. Энциклопедия биржевой игры / Александр Элдер; Пер. с англ. – М.: Альпина Паблишерз, 2013. – 496 с.

Энциклопедия торговых стратегий / Джеффри Оуэн Кац, Донна Л. Маккормик; Пер. с англ. – М.: Альпина Паблишерс, 2007. – 392 с.

ЗАО «Группа РЦБ». Журнал «Рынок ценных бумаг». 

Клуб трейдеров SMART-LAB. 

Программирование на алгоритмическом языке MQL4. Вводный курс. / Сергей Ковалев. - Web: 

Стратегии Forex. 

ARQA Technologies. QUIK. 

FX Guild. Информационный форекс портал. 

MeteQuotes Software Corp. MetaTrader 4. 

MeteQuotes Software Corp. MetaTrader 5. 

MeteQuotes Software Corp. MQL4: Механические торговые системы, тестирование стратегий и пользовательские индикаторы на Meta Trader. 

MS123, LLC. Welth Lab. 

NinjaTrader, LLC. NinjaTrader. 

Thomson Reuters. MetaStock. http://www.metastock.com

WellForex. Разработка тестирование оценка и оптимизация торговых систем – советников на рынке Forex. 

